{% extends 'monitoring/base.html' %}

{% block title %}AI Chat - {{ transformer.transformer_id }}{% endblock %}

{% block extra_styles %}
<style>
    #modelSelect {
        background-color: #1e293b !important;
        color: #fff !important;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23fff' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 36px;
    }
    
    #modelSelect option {
        background-color: #1e293b !important;
        color: #fff !important;
        padding: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Transformer Header -->
    <div class="glass-card p-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="w-16 h-16 rounded-xl {% if transformer.status == 'Healthy' %}status-healthy{% elif transformer.status == 'Warning' %}status-warning{% else %}status-critical{% endif %} flex items-center justify-center">
                    <i class="fas fa-bolt text-white text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold">{{ transformer.transformer_id }}</h1>
                    <p class="text-gray-400">{{ transformer.name }}</p>
                    <div class="flex items-center space-x-4 mt-2">
                        <span class="text-sm px-3 py-1 rounded-full {% if transformer.status == 'Healthy' %}bg-green-500/20 text-green-400{% elif transformer.status == 'Warning' %}bg-yellow-500/20 text-yellow-400{% else %}bg-red-500/20 text-red-400{% endif %}">
                            {{ transformer.status }}
                        </span>
                        <span class="text-sm text-gray-400">
                            <i class="fas fa-heart mr-1"></i>Health: {{ transformer.health_score }}%
                        </span>
                    </div>
                </div>
            </div>
            <a href="{% url 'monitoring:transformer_detail' transformer.transformer_id %}" class="btn-glow px-4 py-2 bg-white/10 rounded-lg hover:bg-white/20 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>Back to Details
            </a>
        </div>
    </div>
    
    <!-- Chat Interface -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Sidebar -->
        <div class="space-y-4">
            <div class="glass-card p-4">
                <h3 class="font-semibold mb-3 text-sm uppercase text-gray-400">Model</h3>
                <select id="modelSelect" class="w-full bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white text-sm">
                    <optgroup label="Groq Cloud">
                        <option value="llama-3.3-70b-versatile" selected>Llama 3.3 70B</option>
                        <option value="llama-3.1-8b-instant">Llama 3.1 8B</option>
                        <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
                        <option value="gemma-7b-it">Gemma 7B</option>
                    </optgroup>
                    <optgroup label="Ollama Local">
                        <option value="phi3">Phi-3</option>
                        <option value="mistral">Mistral</option>
                        <option value="llama3">Llama 3</option>
                    </optgroup>
                </select>
            </div>
            
            <div class="glass-card p-4">
                <h3 class="font-semibold mb-3 text-sm uppercase text-gray-400">Transformer Questions</h3>
                <div class="space-y-2">
                    <button onclick="askQuestion('What is the current health status and main concerns?')" class="w-full text-left text-sm px-3 py-2 bg-white/5 hover:bg-white/10 rounded-lg transition-colors">
                        Current health status
                    </button>
                    <button onclick="askQuestion('Analyze the DGA trends and identify any fault patterns')" class="w-full text-left text-sm px-3 py-2 bg-white/5 hover:bg-white/10 rounded-lg transition-colors">
                        DGA analysis
                    </button>
                    <button onclick="askQuestion('What maintenance actions are recommended?')" class="w-full text-left text-sm px-3 py-2 bg-white/5 hover:bg-white/10 rounded-lg transition-colors">
                        Maintenance recommendations
                    </button>
                    <button onclick="askQuestion('Predict the health index for the next 6 months')" class="w-full text-left text-sm px-3 py-2 bg-white/5 hover:bg-white/10 rounded-lg transition-colors">
                        Health prediction
                    </button>
                    <button onclick="askQuestion('What are the main risk factors?')" class="w-full text-left text-sm px-3 py-2 bg-white/5 hover:bg-white/10 rounded-lg transition-colors">
                        Risk assessment
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="lg:col-span-3 glass-card flex flex-col" style="height: 600px;">
            <div class="p-4 border-b border-white/10 flex items-center space-x-3">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                    <i class="fas fa-robot text-white"></i>
                </div>
                <div>
                    <p class="font-semibold">AI Analysis for {{ transformer.transformer_id }}</p>
                    <p class="text-xs text-gray-400">Context-aware responses</p>
                </div>
            </div>
            
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3">
                <div class="bg-white/5 rounded-xl p-3 max-w-2xl">
                    <p class="text-sm text-gray-300">
                        I'm ready to analyze {{ transformer.transformer_id }} ({{ transformer.name }}). 
                        Current status: <span class="{% if transformer.status == 'Healthy' %}text-green-400{% elif transformer.status == 'Warning' %}text-yellow-400{% else %}text-red-400{% endif %}">{{ transformer.status }}</span>
                        with health score {{ transformer.health_score }}%.
                    </p>
                    <p class="text-sm text-gray-400 mt-2">Ask me anything about this transformer's condition, DGA data, or maintenance needs.</p>
                </div>
            </div>
            
            <div class="p-4 border-t border-white/10">
                <form id="chatForm" class="flex space-x-3">
                    <input type="text" id="questionInput" placeholder="Ask about this transformer..." 
                           class="flex-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white text-sm focus:outline-none focus:border-blue-500">
                    <button type="submit" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl font-semibold text-sm">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const TRANSFORMER_ID = '{{ transformer.transformer_id }}';
    const chatMessages = document.getElementById('chatMessages');
    const chatForm = document.getElementById('chatForm');
    const questionInput = document.getElementById('questionInput');
    const modelSelect = document.getElementById('modelSelect');
    
    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const question = questionInput.value.trim();
        if (!question) return;
        await sendQuestion(question);
    });
    
    async function askQuestion(question) {
        questionInput.value = question;
        await sendQuestion(question);
    }
    
    async function sendQuestion(question) {
        addMessage(question, 'user');
        questionInput.value = '';
        const typingId = showTyping();
        
        try {
            const response = await fetch('/api/chat/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    question: question,
                    model: modelSelect.value,
                    transformer_id: TRANSFORMER_ID
                })
            });
            
            const data = await response.json();
            removeTyping(typingId);
            addMessage(data.answer || data.error, 'ai');
        } catch (error) {
            removeTyping(typingId);
            addMessage('Connection error. Please ensure Ollama is running.', 'ai');
        }
    }
    
    function addMessage(content, type) {
        const div = document.createElement('div');
        div.className = `rounded-xl p-4 max-w-2xl ${type === 'user' ? 'bg-blue-500/30 ml-auto' : 'bg-white/5 border border-white/10'}`;
        
        if (type === 'user') {
            div.innerHTML = `<p class="text-sm text-white font-medium">${escapeHtml(content)}</p>`;
        } else {
            div.innerHTML = `<div class="prose prose-invert prose-sm max-w-none">${formatResponse(content)}</div>`;
        }
        
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function formatResponse(text) {
        // First, escape HTML to prevent XSS
        text = escapeHtml(text);
        
        // Handle code blocks
        text = text.replace(/```(\w*)\n([\s\S]*?)```/g, function(match, lang, code) {
            return `<div class="code-block bg-gray-900 rounded-lg p-4 my-3 overflow-x-auto border border-gray-700"><pre><code class="language-${lang}">${code.trim()}</code></pre></div>`;
        });
        
        // Handle inline code
        text = text.replace(/`([^`]+)`/g, '<code class="bg-blue-500/20 text-blue-300 px-2 py-0.5 rounded font-mono text-sm">$1</code>');
        
        // Handle headers
        text = text.replace(/^### (.*$)/gim, '<h3 class="text-lg font-bold text-purple-400 mt-4 mb-2">$1</h3>');
        text = text.replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold text-blue-400 mt-5 mb-3">$1</h2>');
        text = text.replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold text-white mt-6 mb-4 border-b border-gray-700 pb-2">$1</h1>');
        
        // Handle bold text
        text = text.replace(/\*\*([^*]+)\*\*/g, '<strong class="font-bold text-white">$1</strong>');
        
        // Handle italic text
        text = text.replace(/\*([^*]+)\*/g, '<em class="italic text-gray-300">$1</em>');
        
        // Handle underlined text
        text = text.replace(/__([^_]+)__/g, '<u class="underline decoration-purple-400 decoration-2 underline-offset-2">$1</u>');
        
        // Handle strikethrough
        text = text.replace(/~~([^~]+)~~/g, '<span class="line-through text-gray-500">$1</span>');
        
        // Handle horizontal rules
        text = text.replace(/^---$/gim, '<hr class="border-gray-700 my-4">');
        
        // Handle blockquotes
        text = text.replace(/^> (.*$)/gim, '<blockquote class="border-l-4 border-purple-500 pl-4 my-3 italic text-gray-400 bg-white/5 py-2 rounded-r">$1</blockquote>');
        
        // Handle ordered lists
        text = text.replace(/^\d+\. (.*$)/gim, '<li class="list-decimal ml-6 my-1 text-gray-300">$1</li>');
        
        // Handle unordered lists
        text = text.replace(/^[-*•] (.*$)/gim, `<li class="list-disc ml-6 my-1 text-gray-300"><span class="text-purple-400 mr-2">›</span>$1</li>`);
        
        // Handle links
        text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="text-blue-400 hover:text-blue-300 underline" target="_blank">$1</a>');
        
        // Handle highlighted text
        text = text.replace(/==([^=]+)==/g, '<mark class="bg-yellow-500/30 text-yellow-200 px-1 rounded">$1</mark>');
        
        // Convert multiple newlines to paragraphs
        text = text.replace(/\n\n+/g, '</p><p class="text-gray-300 mb-3 leading-relaxed">');
        
        // Convert single newlines to line breaks
        text = text.replace(/\n/g, '<br>');
        
        // Wrap in paragraph if not already wrapped
        if (!text.startsWith('<')) {
            text = '<p class="text-gray-300 mb-3 leading-relaxed">' + text + '</p>';
        }
        
        // Clean up empty paragraphs
        text = text.replace(/<p class="text-gray-300 mb-3 leading-relaxed"><\/p>/g, '');
        
        return text;
    }
    
    function showTyping() {
        const id = 'typing-' + Date.now();
        const div = document.createElement('div');
        div.id = id;
        div.className = 'bg-white/5 rounded-xl p-3 max-w-2xl';
        div.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
        chatMessages.appendChild(div);
        return id;
    }
    
    function removeTyping(id) {
        document.getElementById(id)?.remove();
    }
</script>
{% endblock %}
